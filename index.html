<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ERS Velocity V5.2</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="ers-logo.png">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --glass-bg: rgba(15, 23, 42, 0.85);
            --primary: #22c55e;
            --primary-glow: rgba(34, 197, 94, 0.3);
            --secondary: #3b82f6;
            --accent: #f59e0b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border-color: rgba(255,255,255,0.08);
        }

        body.light-mode {
            --bg-color: #f1f5f9;
            --card-bg: rgba(255, 255, 255, 0.8);
            --glass-bg: rgba(255, 255, 255, 0.9);
            --primary: #15803d;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border-color: rgba(0,0,0,0.05);
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0; padding: 0;
            display: flex; justify-content: center;
            min-height: 100vh;
            padding-bottom: 90px; /* Space for footer */
            padding-top: 80px; /* Space for fixed header */
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .app-container { width: 100%; max-width: 480px; padding: 15px; position: relative; box-sizing: border-box; }

        /* --- FIXED PRO HEADER --- */
        header {
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
            height: 65px;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .header-content {
            width: 100%; max-width: 480px; padding: 0 15px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-right { text-align: right; }
        .welcome-msg { font-size: 15px; font-weight: 700; line-height: 1.2; }
        .welcome-msg span { color: var(--primary); }
        .logo-img { height: 45px; width: auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); transition: transform 0.2s;}
        .logo-img:active { transform: scale(0.95); }

        /* --- CARDS --- */
        .card {
            background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 20px; padding: 20px; margin-bottom: 15px;
            box-shadow: 0 4px 10px -2px rgba(0, 0, 0, 0.05);
            animation: slideUp 0.4s ease-out;
            backdrop-filter: blur(5px);
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- ENHANCED CHALLENGE BANNER --- */
        .challenge-card {
            background: linear-gradient(135deg, #d97706, #f59e0b);
            border-radius: 20px; padding: 0; margin-bottom: 15px;
            position: relative; overflow: hidden; display: none;
            box-shadow: 0 10px 25px -5px rgba(245, 158, 11, 0.4);
            color: white; border: 1px solid rgba(255,255,255,0.1);
        }
        .challenge-bg-icon {
            position: absolute; left: -10px; bottom: -10px;
            font-size: 80px; opacity: 0.15; rotate: 15deg; pointer-events: none;
        }
        .challenge-top {
            padding: 15px 20px;
            background: rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
        }
        .challenge-badge {
            background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px;
            font-size: 11px; font-weight: bold; display: flex; align-items: center; gap: 5px;
        }
        .refresh-btn {
            background: rgba(255,255,255,0.2); width: 28px; height: 28px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .challenge-body { padding: 15px 20px 20px 20px; }
        .ch-title { font-size: 20px; font-weight: 800; margin: 0 0 5px 0; line-height: 1.3; }
        .ch-desc { font-size: 14px; opacity: 0.95; line-height: 1.6; font-weight: 500; white-space: pre-wrap; }

        /* --- STATS GRID --- */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        .stat-box { background: rgba(125,125,125,0.08); padding: 12px; border-radius: 16px; text-align: center; border: 1px solid var(--border-color); }
        .stat-val { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; }
        .stat-lbl { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

        /* --- FORMS --- */
        label { display: block; margin: 12px 0 6px 0; color: var(--text-muted); font-size: 12px; font-weight: 500; }
        input, select {
            width: 100%; padding: 14px; background: rgba(125,125,125,0.08);
            border: 1px solid var(--border-color); border-radius: 12px;
            color: var(--text-main); font-size: 15px; font-family: inherit; box-sizing: border-box;
            transition: 0.2s;
        }
        input:focus, select:focus { outline: none; border-color: var(--primary); background: rgba(125,125,125,0.12); }

        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 14px;
            font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 15px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, var(--primary), #16a34a); color: #fff; box-shadow: 0 4px 15px var(--primary-glow); }

        /* --- NAV --- */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 440px; background: var(--glass-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 24px; display: flex; justify-content: space-around;
            padding: 12px 0; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 999;
        }
        .nav-item { color: var(--text-muted); text-align: center; font-size: 10px; cursor: pointer; width: 25%; transition: 0.3s; }
        .nav-item i { display: block; font-size: 24px; margin-bottom: 3px; transition: 0.3s; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: translateY(-3px); }

        /* --- UTILS --- */
        .view-section { display: none; }
        .view-section.active { display: block; }
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000;
            display: none; justify-content: center; align-items: center; backdrop-filter: blur(8px);
        }
        .modal-content {
            background: var(--bg-color); width: 85%; max-width: 400px;
            padding: 25px; border-radius: 24px; max-height: 80vh; overflow-y: auto;
            border: 1px solid var(--border-color); box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .float-btns { position: fixed; bottom: 100px; right: 20px; display: flex; flex-direction: column; gap: 12px; z-index: 900; }
        .float-btn {
            width: 48px; height: 48px; border-radius: 50%; background: var(--card-bg);
            border: 1px solid var(--border-color); display: flex; justify-content: center; align-items: center;
            font-size: 22px; color: var(--text-muted); box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <div class="header-right">
            <div style="font-size:11px; color:var(--text-muted); font-weight:500;" id="dateDisplay">--</div>
            <div class="welcome-msg" id="headerGreeting"></div>
        </div>
        <img src="ers-logo.png" class="logo-img" alt="ERS" onclick="window.scrollTo(0,0)">
    </div>
</header>

<div class="app-container">

    <div id="view-dashboard" class="view-section active">
        
        <div id="challengeLoader" style="font-size:12px; text-align:center; color:var(--text-muted); margin-bottom:10px;">
            <i class="ri-loader-4-line ri-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ÙØ±ÙŠÙ‚...
        </div>
        
        <div id="globalChallengeBanner" class="challenge-card">
            <i class="ri-trophy-fill challenge-bg-icon"></i>
            <div class="challenge-top">
                <div class="challenge-badge"><i class="ri-flag-2-fill"></i> ØªØ­Ø¯ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚</div>
                <div class="refresh-btn" onclick="fetchGlobalChallenge(true)"><i class="ri-refresh-line"></i></div>
            </div>
            <div class="challenge-body">
                <h3 class="ch-title" id="gcTitle">...</h3>
                <div class="ch-desc" id="gcDesc">...</div>
                
                <div style="margin-top:15px; display:flex; gap:5px; align-items:center;">
                    <div style="flex:1; height:6px; background:rgba(255,255,255,0.3); border-radius:10px;">
                        <div style="width:60%; height:100%; background:white; border-radius:10px;"></div>
                    </div>
                    <span style="font-size:10px;">Ø§Ù†Ø¶Ù…Ø§Ù…</span>
                </div>
            </div>
        </div>

        <div class="card" style="border-right: 4px solid var(--primary); padding-right:15px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h3 style="margin:0; font-size:16px; display:flex; gap:6px; align-items:center;"><i class="ri-robot-2-line" style="color:var(--primary)"></i> ÙƒÙˆØªØ´ ERS</h3>
                <span id="goalBadge" style="font-size:10px; background:rgba(34,197,94,0.1); color:var(--primary); padding:3px 8px; border-radius:8px; border:1px solid rgba(34,197,94,0.2);"></span>
            </div>
            <div id="smartSuggestion" style="font-size:14px; line-height:1.7; color:var(--text-main);">
                Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...
            </div>
        </div>

        <div class="card">
            <h3 style="margin:0 0 15px 0; font-size:16px;">ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡</h3>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-val" style="color:var(--primary)" id="weekDist">0</div>
                    <div class="stat-lbl">Ø£Ø³Ø¨ÙˆØ¹ÙŠ (ÙƒÙ…)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-val" style="color:var(--secondary)" id="monthDist">0</div>
                    <div class="stat-lbl">Ø´Ù‡Ø±ÙŠ (ÙƒÙ…)</div>
                </div>
            </div>
            <div style="margin-top:15px;">
                <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:6px; color:var(--text-muted);">
                    <span>Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</span><span id="weekGoalTxt">0/0</span>
                </div>
                <div style="height:8px; background:rgba(125,125,125,0.1); border-radius:10px; overflow:hidden;">
                    <div id="weekBar" style="height:100%; width:0%; background:linear-gradient(90deg, var(--primary), #4ade80); border-radius:10px; transition:width 1s;"></div>
                </div>
            </div>
        </div>
        
        <button class="btn btn-primary" onclick="switchView('log')"><i class="ri-add-line"></i> ØªØ³Ø¬ÙŠÙ„ Ø¬Ø±ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
    </div>

    <div id="view-log" class="view-section">
        <div class="card">
            <h3 style="margin-top:0;">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø·</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                <div><label>Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙƒÙ…)</label><input type="number" id="logDist" step="0.1" inputmode="decimal"></div>
                <div><label>Ø§Ù„Ø²Ù…Ù† (Ø¯Ù‚Ø§Ø¦Ù‚)</label><input type="number" id="logTime" inputmode="numeric"></div>
            </div>
            <label>Ù†ÙˆØ¹ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</label>
            <select id="logType">
                <option value="easy">Easy Run (Ø³Ù‡Ù„)</option>
                <option value="long">Long Run (Ø·ÙˆÙŠÙ„)</option>
                <option value="tempo">Tempo (Ø¥ÙŠÙ‚Ø§Ø¹ Ø³Ø±ÙŠØ¹)</option>
                <option value="interval">Intervals (Ø³Ø±Ø¹Ø©/ØªÙƒØ±Ø§Ø±Ø§Øª)</option>
                <option value="race">Race (Ø³Ø¨Ø§Ù‚)</option>
                <option value="recovery">Recovery (Ø§Ø³ØªØ´ÙØ§Ø¡)</option>
            </select>
            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="logDate">
            <button class="btn btn-primary" onclick="addRun()">Ø­ÙØ¸</button>
        </div>
        <div class="card">
            <h4 style="margin:0 0 10px 0;">Ø§Ù„Ø³Ø¬Ù„ (Ø¢Ø®Ø± 15)</h4>
            <div id="runsList" style="max-height:300px; overflow-y:auto; font-size:13px;"></div>
        </div>
    </div>

    <div id="view-profile" class="view-section">
        <div class="card">
            <h3 style="margin-top:0;">ğŸ‘¤ Ù…Ù„Ù Ø§Ù„ÙƒØ§Ø¨ØªÙ†</h3>
            <label>Ø§Ù„Ø§Ø³Ù…</label><input type="text" id="profName">
            
            <label>Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label>
            <select id="profGoalType">
                <option value="fitness">ğŸ’ª Ù„ÙŠØ§Ù‚Ø© ÙˆØªØ®Ø³ÙŠØ³</option>
                <option value="endurance">ğŸƒâ€â™‚ï¸ ØªØ­Ù…Ù„ ÙˆÙ…Ø³Ø§ÙØ§Øª</option>
                <option value="speed">âš¡ Ø³Ø±Ø¹Ø© ÙˆØªØ­Ø·ÙŠÙ… Ø£Ø±Ù‚Ø§Ù…</option>
            </select>

            <h4 style="color:var(--secondary); margin:20px 0 10px 0; font-size:13px; border-bottom:1px solid var(--border-color); padding-bottom:5px;">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø³Ù…Ø§Ù†ÙŠØ©</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px;">
                <div><label>Ø§Ù„ÙˆØ²Ù† (kg)</label><input type="number" id="profWeight"></div>
                <div><label>Ø§Ù„Ø·ÙˆÙ„ (cm)</label><input type="number" id="profHeight"></div>
                <div><label>Ø§Ù„Ø®ØµØ± (cm)</label><input type="number" id="profWaist"></div>
            </div>
            <div id="bmiResult" style="text-align:center; font-size:12px; margin-top:8px; color:var(--text-muted);"></div>

            <h4 style="color:var(--secondary); margin:20px 0 10px 0; font-size:13px; border-bottom:1px solid var(--border-color); padding-bottom:5px;">Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ø£Ù‡Ø¯Ø§Ù</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div><label>Ø£ÙØ¶Ù„ 5K (Ø¯)</label><input type="number" id="profPb5k"></div>
                <div><label>Ø£ÙØ¶Ù„ 10K (Ø¯)</label><input type="number" id="profPb10k"></div>
            </div>
            <label>Ø£Ø·ÙˆÙ„ Ø¬Ø±ÙŠØ© Ø¢Ø®Ø± 30 ÙŠÙˆÙ… (ÙƒÙ…)</label><input type="number" id="profLongest">
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                <div><label>Ù‡Ø¯Ù Ø£Ø³Ø¨ÙˆØ¹ÙŠ</label><input type="number" id="profGoalWeek"></div>
                <div><label>Ù‡Ø¯Ù Ø´Ù‡Ø±ÙŠ</label><input type="number" id="profGoalMonth"></div>
            </div>

            <button class="btn btn-primary" onclick="saveProfile()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        </div>
    </div>
    
    <div id="view-calculator" class="view-section">
        <div class="card">
            <h3>â±ï¸ Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù€ Pace</h3>
            <label>Ø§Ù„Ù…Ø³Ø§ÙØ©</label><input type="number" id="calcDist" placeholder="ÙƒÙ…">
            <label>Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</label>
            <div style="display:flex; gap:10px;">
                <input type="number" id="calcHrs" placeholder="Ø³"><input type="number" id="calcMins" placeholder="Ø¯">
            </div>
            <button class="btn btn-primary" onclick="calculatePace()">Ø§Ø­Ø³Ø¨</button>
            <div id="calcResult" style="display:none; text-align:center; margin-top:20px; padding:15px; background:rgba(0,0,0,0.1); border-radius:12px;">
                <h2 id="paceDisplay" style="margin:0; color:var(--primary); font-size:32px;"></h2>
                <span style="font-size:12px;">Ø¯Ù‚ÙŠÙ‚Ø© / ÙƒÙ…</span>
            </div>
        </div>
    </div>

</div>

<div class="float-btns">
    <div class="float-btn" onclick="openModal('settingsModal')"><i class="ri-settings-3-line"></i></div>
    <div class="float-btn" onclick="openModal('helpModal')"><i class="ri-question-mark"></i></div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="switchView('dashboard')"><i class="ri-dashboard-line"></i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
    <div class="nav-item" onclick="switchView('calculator')"><i class="ri-timer-flash-line"></i><span>Ø§Ù„Ø­Ø§Ø³Ø¨Ø©</span></div>
    <div class="nav-item" onclick="switchView('log')"><i class="ri-file-list-3-line"></i><span>Ø§Ù„Ø³Ø¬Ù„</span></div>
    <div class="nav-item" onclick="switchView('profile')"><i class="ri-user-settings-line"></i><span>Ø¨Ø±ÙˆÙØ§ÙŠÙ„ÙŠ</span></div>
</div>

<div id="helpModal" class="modal-overlay" onclick="if(event.target===this) closeModal('helpModal')">
    <div class="modal-content" style="text-align:right;">
        <h3 style="color:var(--primary); text-align:center;">Ø¯Ù„ÙŠÙ„ V5.2</h3>
        <p style="font-size:13px; line-height:1.6; color:var(--text-muted)">
            ØªÙ… ØªØ­Ø³ÙŠÙ† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„ØªÙƒÙˆÙ† Ø£Ø³Ø±Ø¹ ÙˆØ£Ø³Ù‡Ù„. Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª ØªØ¸Ù‡Ø± Ø§Ù„Ø¢Ù† Ø¨Ø´ÙƒÙ„ Ù…Ø¨Ø§Ø´Ø± Ù…Ù† Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙŠÙ‚. Ø§Ù„Ù‡ÙŠØ¯Ø± Ø«Ø§Ø¨Øª Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„ÙˆØµÙˆÙ„.
        </p>
        <button class="btn btn-outline" onclick="closeModal('helpModal')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div id="settingsModal" class="modal-overlay" onclick="if(event.target===this) closeModal('settingsModal')">
    <div class="modal-content">
        <h3 style="text-align:center;">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
        <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(125,125,125,0.1); padding:12px; border-radius:12px; margin-bottom:15px;">
            <span>Ø§Ù„Ù…Ø¸Ù‡Ø± (Ù„ÙŠÙ„ÙŠ/Ù†Ù‡Ø§Ø±ÙŠ)</span>
            <div onclick="toggleTheme()" style="cursor:pointer; font-size:22px;">ğŸŒ“</div>
        </div>
        <button class="btn btn-outline" onclick="exportData()"><i class="ri-download-cloud-line"></i> Ø­ÙØ¸ Ù†Ø³Ø®Ø© (Backup)</button>
        <div style="position:relative; margin-top:10px;">
            <button class="btn btn-outline" onclick="document.getElementById('importFile').click()"><i class="ri-upload-cloud-line"></i> Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù†Ø³Ø®Ø©</button>
            <input type="file" id="importFile" style="display:none" onchange="importData(this)">
        </div>
        <button class="btn btn-primary" onclick="window.location.reload(true)" style="margin-top:20px; background:var(--secondary);"><i class="ri-refresh-line"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
        <p style="text-align:center; font-size:10px; color:var(--text-muted); margin-top:10px;">ERS V5.2 Pro</p>
    </div>
</div>

<script>
    // --- APP DATA ---
    let appData = {
        profile: { name: "", weeklyGoal: 30, monthlyGoal: 100, goalType: "fitness", weight: "", height: "", waist: "", pb5k: "", pb10k: "", longestRun: "" },
        runs: [],
        settings: { theme: 'dark' }
    };

    function init() {
        const saved = localStorage.getItem('ers_data_v5');
        if (saved) appData = JSON.parse(saved);
        if (appData.settings.theme === 'light') document.body.classList.add('light-mode');
        
        // Date Display
        const d = new Date();
        document.getElementById('dateDisplay').innerText = d.toLocaleDateString('ar-EG', {weekday:'short', day:'numeric', month:'short'});
        document.getElementById('logDate').valueAsDate = d;

        updateUI();
        fetchGlobalChallenge();
        
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('service-worker.js');
    }
    
    function saveData() { localStorage.setItem('ers_data_v5', JSON.stringify(appData)); updateUI(); }

    function updateUI() {
        // Header
        document.getElementById('headerGreeting').innerHTML = `Ø£Ù‡Ù„Ø§Ù‹ØŒ <span>${appData.profile.name.split(' ')[0] || 'ÙƒØ§Ø¨ØªÙ†'}</span>`;
        
        const goalsMap = { 'fitness': 'Ø­Ø±Ù‚ Ø¯Ù‡ÙˆÙ†', 'endurance': 'ØªØ­Ù…Ù„', 'speed': 'Ø³Ø±Ø¹Ø©' };
        document.getElementById('goalBadge').innerText = goalsMap[appData.profile.goalType] || 'Ø¹Ø§Ù…';

        // Stats
        const now = new Date();
        const startW = new Date(now.setDate(now.getDate() - now.getDay()));
        const startM = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
        
        const wDist = appData.runs.filter(r => new Date(r.date) >= startW).reduce((s,r)=>s+r.dist,0);
        const mDist = appData.runs.filter(r => new Date(r.date) >= startM).reduce((s,r)=>s+r.dist,0);
        
        document.getElementById('weekDist').innerText = wDist.toFixed(1);
        document.getElementById('monthDist').innerText = mDist.toFixed(1);
        
        const wGoal = appData.profile.weeklyGoal || 30;
        const pct = Math.min((wDist/wGoal)*100, 100);
        document.getElementById('weekBar').style.width = pct + "%";
        document.getElementById('weekGoalTxt').innerText = `${Math.floor(wDist)}/${wGoal}`;

        renderLogs();
        generateSmartSuggestion();
    }

    // --- CSV PARSER (The Robust Solution) ---
    function parseCSV(text) {
        // This function handles CSVs properly even with commas inside quotes
        let results = [];
        let row = [];
        let inQuote = false;
        let currentCell = "";
        
        for (let i = 0; i < text.length; i++) {
            let char = text[i];
            let nextChar = text[i+1];
            
            if (char === '"') {
                inQuote = !inQuote;
            } else if (char === ',' && !inQuote) {
                row.push(currentCell.trim());
                currentCell = "";
            } else if ((char === '\r' || char === '\n') && !inQuote) {
                if (currentCell || row.length > 0) row.push(currentCell.trim());
                if (row.length > 0) results.push(row);
                row = [];
                currentCell = "";
                if (char === '\r' && nextChar === '\n') i++; // skip next \n
            } else {
                currentCell += char;
            }
        }
        if (currentCell || row.length > 0) row.push(currentCell.trim());
        if (row.length > 0) results.push(row);
        return results;
    }

    async function fetchGlobalChallenge(forceRefresh = false) {
        if(forceRefresh) {
            document.getElementById('challengeLoader').style.display = 'block';
            document.getElementById('globalChallengeBanner').style.display = 'none';
        }

        let SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSJ1EllXPDXThEec-zwpqZBMY5pYOI-jLNu0Zjr6nLI2wXONsNPKkN-BIIY1jRDJN7VG6KQAPFJX7Zr/pub?gid=0&single=true&output=csv";
        SHEET_URL += "&t=" + new Date().getTime(); // Anti-cache

        try {
            const res = await fetch(SHEET_URL, { cache: "no-store" });
            const text = await res.text();
            
            // Use the Robust Parser
            const rows = parseCSV(text);
            
            if(rows.length > 1) {
                // Row 0 is headers, Row 1 is data
                const title = rows[1][0];
                const desc = rows[1][1];

                if(title) {
                    document.getElementById('gcTitle').innerText = title;
                    document.getElementById('gcDesc').innerText = desc || "";
                    document.getElementById('challengeLoader').style.display = 'none';
                    document.getElementById('globalChallengeBanner').style.display = 'block';
                }
            }
        } catch (e) {
            console.log("Fetch Error", e);
            document.getElementById('challengeLoader').innerText = "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.";
        }
    }

    // --- LOGIC ---
    function generateSmartSuggestion() {
        const box = document.getElementById('smartSuggestion');
        const goal = appData.profile.goalType;
        if(appData.runs.length === 0) { box.innerHTML = "Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø§Ø¨Ø¯Ø£ Ø¨ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„ Ø¬Ø±ÙŠØ©."; return; }

        const lastRun = appData.runs[0];
        const daysDiff = Math.floor((new Date() - new Date(lastRun.date))/(1000*3600*24));
        let advice = "";
        
        if(daysDiff === 0) advice = "Ø±Ø§Ø­Ø© Ø§Ù„ÙŠÙˆÙ…. (Rest Day) ğŸ§˜â€â™‚ï¸";
        else if(daysDiff > 5) advice = "Ø¹ÙˆØ¯Ø© ØªØ¯Ø±ÙŠØ¬ÙŠØ©: 3ÙƒÙ… Easy Run.";
        else {
            if(goal === 'fitness') advice = "Ù„Ø­Ø±Ù‚ Ø§Ù„Ø¯Ù‡ÙˆÙ†: 45 Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ø´ÙŠ Ø³Ø±ÙŠØ¹ Ø£Ùˆ Ù‡Ø±ÙˆÙ„Ø© (Zone 2).";
            else if(goal === 'speed') {
                if(lastRun.type==='interval') advice = "Recovery Run 5km.";
                else advice = "Speed: 1km Warmup + 5x400m fast.";
            } else advice = "Endurance: Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ ÙˆØªÙŠØ±Ø© Ø«Ø§Ø¨ØªØ© Ù„Ù…Ø³Ø§ÙØ© 8-10 ÙƒÙ….";
        }
        box.innerHTML = advice;
    }

    function addRun() {
        const d = parseFloat(document.getElementById('logDist').value);
        const t = parseFloat(document.getElementById('logTime').value);
        if(!d || !t) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");
        appData.runs.unshift({id:Date.now(), dist:d, time:t, type:document.getElementById('logType').value, date:document.getElementById('logDate').value});
        saveData(); switchView('dashboard');
    }

    function saveProfile() {
        appData.profile.name = document.getElementById('profName').value;
        appData.profile.goalType = document.getElementById('profGoalType').value;
        appData.profile.weight = document.getElementById('profWeight').value;
        appData.profile.height = document.getElementById('profHeight').value;
        appData.profile.waist = document.getElementById('profWaist').value;
        appData.profile.pb5k = document.getElementById('profPb5k').value;
        appData.profile.pb10k = document.getElementById('profPb10k').value;
        appData.profile.longestRun = document.getElementById('profLongest').value;
        appData.profile.weeklyGoal = parseFloat(document.getElementById('profGoalWeek').value) || 30;
        appData.profile.monthlyGoal = parseFloat(document.getElementById('profGoalMonth').value) || 100;
        saveData(); alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…"); switchView('dashboard');
    }

    function renderLogs() {
        const list = document.getElementById('runsList'); list.innerHTML = "";
        appData.runs.slice(0, 15).forEach(r => {
            list.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid var(--border-color); align-items:center;">
                <div><span style="color:var(--primary); font-weight:bold;">${r.dist}km</span> <span style="font-size:11px; opacity:0.7">(${r.type})</span></div>
                <div style="font-size:11px; opacity:0.6">${r.date.slice(5)}</div>
            </div>`;
        });
    }

    function calculatePace() {
        let d = parseFloat(document.getElementById('calcDist').value);
        let h = parseFloat(document.getElementById('calcHrs').value) || 0;
        let m = parseFloat(document.getElementById('calcMins').value) || 0;
        if(!d) return;
        let pace = ((h*60)+m)/d;
        let pMin = Math.floor(pace); let pSec = Math.round((pace-pMin)*60);
        document.getElementById('paceDisplay').innerText = `${pMin}:${pSec<10?'0'+pSec:pSec}`;
        document.getElementById('calcResult').style.display = 'block';
    }

    function switchView(v) {
        document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        document.getElementById('view-'+v).classList.add('active');
        const map = {'dashboard':0, 'calculator':1, 'log':2, 'profile':3};
        document.querySelectorAll('.nav-item')[map[v]].classList.add('active');
        window.scrollTo(0,0);
        if(v==='profile') populateProfile();
    }

    function populateProfile() {
        const p = appData.profile;
        document.getElementById('profName').value = p.name;
        document.getElementById('profGoalType').value = p.goalType;
        document.getElementById('profWeight').value = p.weight;
        document.getElementById('profHeight').value = p.height;
        document.getElementById('profWaist').value = p.waist;
        document.getElementById('profPb5k').value = p.pb5k;
        document.getElementById('profPb10k').value = p.pb10k;
        document.getElementById('profLongest').value = p.longestRun;
        document.getElementById('profGoalWeek').value = p.weeklyGoal;
        document.getElementById('profGoalMonth').value = p.monthlyGoal;
        if(p.weight && p.height) {
            const bmi = (p.weight / ((p.height/100)**2)).toFixed(1);
            document.getElementById('bmiResult').innerHTML = `BMI: <strong>${bmi}</strong>`;
        }
    }

    function toggleTheme() {
        document.body.classList.toggle('light-mode');
        appData.settings.theme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
        saveData();
    }
    
    function exportData() {
        const str = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
        const el = document.createElement('a'); el.href = str; el.download = "ers_backup.json"; el.click();
    }
    
    function importData(input) {
        const reader = new FileReader();
        reader.onload = function(e) { appData = JSON.parse(e.target.result); saveData(); location.reload(); };
        reader.readAsText(input.files[0]);
    }

    function openModal(id) { document.getElementById(id).style.display='flex'; }
    function closeModal(id) { document.getElementById(id).style.display='none'; }

    init();
</script>
</body>
</html>
